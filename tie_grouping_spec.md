# タイ付き音符の一般的グルーピング仕様書

以下は，任意の拍子・subdivision に対して，連続するタイ付き音符を標準音価・付点音価・連符音価の組み合わせで最適に分解し，譜面上でグルーピングするための仕様です。パターン分けによらず，素因数分解と貪欲分解によってすべてのケースを網羅します。

---

## 1. 用語定義

- **拍子分子 N**：小節あたりの拍数（例：4/4 なら N=4，6/8 なら N=6）。  
- **Subdivision S**：1拍を細かく分割した単位数（例：4/4 の16分音符であれば S=4）。  
- **最小単位**：Subdivision あたりの最小音価を 1 としたとき，小節全体は N×S 単位。  
- **ラン長 L**：連続したタイで結ばれた音符群の合計長（最小単位換算）。  
- **記譜値集合 D**：次節で定義する，全ての可能な音価の集合。  

---

## 2. 記譜値集合 D の構成

1. **標準音価（2進分割）**  
   - 計算式：  
     ```
     d = (N * S) / (2^k)  (k = 0, 1, 2, …)
     ```  
   - 例：4/4, S=4 の場合 → 全音符 = 16, 二分音符 = 8, 四分音符 = 4, 八分音符 = 2, 十六分音符 = 1  

2. **付点音価**  
   - 単付点: 標準音価 d × 1.5  
   - 重付点: 標準音価 d × 1.75 など（必要に応じて）  

3. **連符音価**  
   - 計算式：  
     ```
     d = S / n
     ```  
   - 条件：n は S または (N * S) の約数（例：3連符, 5連符, 7連符…）  
   - 例：四分音符３連符 → 4 ÷ 3 ≒ 1.333… （最小単位に換算可能なもの）  

4. **その他拡張**  
   - 多重ドット（例：二重付点）  
   - 素因数に基づく任意の n 連符  

---

## 3. グルーピングアルゴリズム

1. **ラン検出**：  
   譜面上で連続するタイ付き音符を抽出し，ラン長 L を最小単位で計算。  
2. **境界処理**：  
   小節境界および強拍境界をまたぐ場合，それぞれでランを分割。  
3. **貪欲分解**：  
   1. 現在の開始位置で配置可能な D の要素のうち，最も長い音価 d_max を選択。  
   2. `L = L - d_max` とし，開始位置を d_max 分だけ進める。  
   3. 残り長 `L > 0` なら 3.1 に戻る。  
4. **ノーマライズ**：  
   取得した音価 d_max の列を順に並べ替え，結合後の音符として出力。  

---

## 4. 適用例

#### 4/4, S=4 の場合（小節全体 = 16 単位）

- **例1**: `[64-, t, 64, 64]`  
  - ラン長 L = 4 + 4 + 4 + 4 = 16  
  - 貪欲分解:  
    1. d_max = 8 (二分音符), 残り L = 8  
    2. d_max = 4 (四分音符), 残り L = 4  
    3. d_max = 4  
  - 結果: 二分音符, 四分音符, 四分音符  

- **例2**: `[64, 64-, t, 64]`  
  - L = 16  
  - 貪欲分解: d_max = 8 → 残り = 8 → d_max = 8  
  - 結果: 四分音符, 二分音符, 四分音符  

- **例3**: `[64-, t, t, t]`  
  - L = 16  
  - d_max = 16 (全音符)  
  - 結果: 全音符  

- **例4** (付点二分音符): `[64-, t, t, 64]`  
  - L = 16  
  - d_max = 12 (付点二分音符), 残り L = 4 → d_max = 4  
  - 結果: 付点二分音符, 四分音符  

---

#### 3/4, S=4 の場合（小節全体 = 12 単位）

- `[64-, t, 64]` → L = 12 → d_max = 8 (二分音符), 残り = 4 → 四分音符 → 二分音符, 四分音符  
- `[64, 64-, t]` → 四分音符, 二分音符  

---

#### 6/8, S=2 の場合（小節全体 = 12 単位）

- `[64-, t, 64, 64, 64-, t]` → L = 2+2+2+2+2+2 = 12  
  - d_max = 4 (四分音符), 残り = 8 → d_max = 4, 残り = 4 → d_max = 4  
  - 結果: 四分音符, 八分音符, 八分音符, 四分音符  

---

## 5. 拡張・注意事項

- **複合 tuplets**: 素因数ごとに個別処理してください。  
- **小節またぎ**: 必要に応じてラン検出前に分割ルールを追加してください。  
- **多重付点**: 「付点音価」の拡張として対応可能です。  

以上の手順により，任意の拍子・subdivision におけるすべての連続したタイ付き音符のグルーピングを網羅的に実装できます。

---

## 6. 複合Subdivisionの計算順序の具体例

以下のように，7/4 拍子内で複数の subdivision が混在する場合を例示します。

```text
7/4 [
  [64-, t, 64],
  [64-, t, t, 64-, t],
  [64-, t, 64-, t, 64-, t, 64],
  64,
  [64, 64-, t, t, 64-, t, t, 64, 64-, t, t],
  [64-, t, t, t, t, t, t],
  [64, 64-, t, t, 64-, t, 64, 64-, t, t, t, 64]
]
```

### 6.1 ラン検出

小節を以下の **7 つのラン** に分割します：  
1. [64-, t, 64]  
2. [64-, t, t, 64-, t]  
3. [64-, t, 64-, t, 64-, t, 64]  
4. 64  
5. [64, 64-, t, t, 64-, t, t, 64, 64-, t, t]  
6. [64-, t, t, t, t, t, t]  
7. [64, 64-, t, t, 64-, t, 64, 64-, t, t, t, 64]  

### 6.2 各ランのローカルSubdivision（仮定）

| ラン番号 | ラン表記                                   | S_i |
|:------:|:-----------------------------------------|:----:|
| 1      | [64-, t, 64]                             | 3    |
| 2      | [64-, t, t, 64-, t]                      | 4    |
| 3      | [64-, t, 64-, t, 64-, t, 64]             | 7    |
| 4      | 64                                       | 2    |
| 5      | [64, 64-, t, t, 64-, t, t, 64, 64-, t, t] | 5    |
| 6      | [64-, t, t, t, t, t, t]                  | 6    |
| 7      | [64, 64-, t, t, 64-, t, 64, 64-, t, t, t, 64] | 11   |

### 6.3 統一Subdivisionの決定

```
S_global = LCM(3, 4, 7, 2, 5, 6, 11) = 4620
L_total  = N × S_global = 7 × 4620 = 32340 単位
```

### 6.4 各ラン長の計算

ラン長 L_i を以下の式で求め，テーブルにまとめます。

```
L_i = (#要素) × (S_global / S_i)
```

| ラン | #要素 | S_i | L_i = #要素 × (4620 / S_i) |
|:---:|:----:|:---:|:--------------------------:|
| 1   | 3    | 3   | 3 × 1540 = 4620            |
| 2   | 5    | 4   | 5 × 1155 = 5775            |
| 3   | 7    | 7   | 7 × 660  = 4620            |
| 4   | 1    | 2   | 1 × 2310 = 2310            |
| 5   | 11   | 5   | 11 × 924 = 10164           |
| 6   | 7    | 6   | 7 × 770  = 5390            |
| 7   | 12   | 11  | 12 × 420 = 5040            |

### 6.5 貪欲分解

各ラン長 L_i に対して，仕様セクション3 の記譜値集合 D を大きい順に適用し，L_i を分解します。

### 6.6 ノーマライズ

貪欲分解で得られた音価列を，譜例表記に変換して出力します。

---

このように，複合的に異なる subdivision が混在していても，  
「LCM による統一単位」と「貪欲分解」で全てのケースを漏れなく処理できます。  
